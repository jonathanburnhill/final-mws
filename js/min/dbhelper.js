class DBHelper{static get DATABASE_URL(){return"http://localhost:1337/"}static dbPromise(){return idb.open("db",3,e=>{switch(e.oldVersion){case 0:e.createObjectStore("restaurants",{keyPath:"id"});case 1:e.createObjectStore("reviews",{keyPath:"id"}).createIndex("restaurant","restaurant_id")}})}static fetchRestaurants(){return this.dbPromise().then(e=>{return e.transaction("restaurants").objectStore("restaurants").getAll()}).then(e=>0!==e.length?Promise.resolve(e):this.fetchAndCacheRestaurantData())}static fetchAndCacheRestaurantData(){return fetch(DBHelper.DATABASE_URL+"restaurants").then(e=>e.json()).then(e=>this.dbPromise().then(t=>{const r=t.transaction("restaurants","readwrite"),a=r.objectStore("restaurants");return e.forEach(e=>a.put(e)),r.complete.then(()=>Promise.resolve(e))}))}static fetchRestaurantById(e){return DBHelper.fetchRestaurants().then(t=>t.find(t=>t.id===e))}static fetchRestaurantByCuisine(e){return DBHelper.fetchRestaurants().then(t=>t.filter(t=>t.cuisine_type===e))}static fetchRestaurantByNeighborhood(e){return DBHelper.fetchRestaurants().then(t=>t.filter(t=>t.neighborhood===e))}static fetchRestaurantByCuisineAndNeighborhood(e,t){return DBHelper.fetchRestaurants().then(r=>{let a=r;return"all"!==e&&(a=a.filter(t=>t.cuisine_type==e)),"all"!==t&&(a=a.filter(e=>e.neighborhood==t)),a})}static fetchNeighborhoods(){return DBHelper.fetchRestaurants().then(e=>{const t=e.map((t,r)=>e[r].neighborhood);return t.filter((e,r)=>t.indexOf(e)==r)})}static fetchCuisines(e){return DBHelper.fetchRestaurants().then(e=>{const t=e.map((t,r)=>e[r].cuisine_type);return t.filter((e,r)=>t.indexOf(e)==r)})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){fetch(`/images/${e.photograph}-thumbnail.webp`)}static retinaUrlForRestaurant(e){return`/${e.retina}`}static altTagsForImages(e){return e.name}static mapMarkerForRestaurant(e,t){const r=new L.Marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:DBHelper.urlForRestaurant(e)});return r.addTo(newMap),r}static addReview(e){let t={name:"addUserReview",data:e,object_type:"review"};if(!navigator.onLine&&"addUserReview"===t.name)return void DBHelper.sendReviewsWhenOnline(t);const r={name:e.name,rating:parseInt(e.rating),comments:e.comments,restaurant_id:parseInt(e.restaurant_id)},a={method:"POST",body:JSON.stringify(r),headers:new Headers({"Content-Type":"application/json"})};fetch(DBHelper.DATABASE_URL+"reviews",a).then(e=>{const t=e.headers.get("content-type");return t&&-1!==t.indexOf("application/json")?e.json():"API callback was a success"}).then(e=>{console.log(e)}).catch(e=>{console.log(e)})}static sendReviewsWhenOnline(e){localStorage.setItem("data",JSON.stringify(e.data)),window.addEventListener("online",t=>{const r=JSON.parse(localStorage.getItem("data"));[...document.querySelectorAll(".offline")].forEach(e=>{e.classList.remove("offline"),e.querySelector(".offline_label").remove()}),null!==r&&("addUserReview"===e.name&&DBHelper.addReview(e.data),localStorage.removeItem("data"))})}static updateFavouriteRestaurant(e,t){fetch(`http://localhost:1337/restaurants/${e}/?is_favorite=${t}`,{method:"PUT"}).then(()=>{this.dbPromise().then(r=>{const a=r.transaction("restaurants","readwrite").objectStore("restaurants");a.get(e).then(e=>{e.is_favorite=t,a.put(e)})})})}static storeIndexedDB(e,t){this.dbPromise.then(function(r){if(!r)return;const a=r.transaction(e,"readwrite").objectStore(e);Array.isArray(t)?t.forEach(function(e){a.put(e)}):a.put(t)})}static getStoredById(e,t,r){return this.dbPromise().then(a=>{if(!a)return;return a.transaction(e).objectStore(e).index(t).getAll(r)})}static fetchReviewsById(e){return fetch(`${DBHelper.DATABASE_URL}reviews/?restaurant_id=${e}`).then(e=>e.json()).then(e=>(this.dbPromise().then(t=>{if(!t)return;const r=t.transaction("reviews","readwrite").objectStore("reviews");Array.isArray(e)?e.forEach(e=>{r.put(e)}):r.put(e)}),Promise.resolve(e))).catch(()=>DBHelper.getStoredById("reviews","restaurant",e).then(e=>Promise.resolve(e)))}}